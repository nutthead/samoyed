# ============================================================================
# release-plz Configuration
# ============================================================================
# Automated release management with smart version bumping and changelog
# generation based on conventional commits.
#
# Features:
# - Automatic PR creation with version bumps
# - Changelog generation using git-cliff
# - Dependency updates
# - Workspace support (single crate in this case)
# - GitHub release creation

[workspace]
# Enable dependency updates in release PRs
dependencies_update = true

# Allow dirty working directory (useful for CI)
allow_dirty = false

# Update the changelog using the git-cliff template
changelog_update = true

# PR body template
pr_body = """
## ğŸš€ Release PR{% if releases | length == 1 %} for v{{ releases[0].next_version }}{% endif %}

This PR was automatically created by [release-plz](https://github.com/MarcoIeni/release-plz) and contains:

### ğŸ“¦ Version Updates
{% for r in releases -%}
- **{{ r.package }}**: `{{ r.previous_version }}` â†’ `{{ r.next_version }}`
{% endfor %}
{% for r in releases -%}
{% if r.changelog | default(value="") | trim | length > 0 %}
### ğŸ“ Changelog for {{ r.package }}
{{ r.changelog }}
{% endif %}
{%- if r.breaking_changes | default(value="") | trim | length > 0 %}
### âš ï¸ Breaking Changes in {{ r.package }}
{{ r.breaking_changes }}
{% endif %}
{%- endfor %}
### âœ… Checklist
- [ ] Version bump looks correct
- [ ] Changelog entries are accurate
- [ ] All CI checks pass
- [ ] Breaking changes are properly documented

### ğŸ”„ Merge Instructions
When you merge this PR, the following will happen automatically:
1. New git tags will be created:
{% for r in releases -%}
   - `v{{ r.next_version }}` for {{ r.package }}
{% endfor -%}
2. GitHub release will be published with binaries
3. The crate will be published to crates.io
4. Attestations and signatures will be generated

---
*This is an automated PR. Please review carefully before merging.*
"""

# ============================================================================
# Package-specific configuration
# ============================================================================
[[package]]
name = "samoyed"
changelog_path = "CHANGELOG.md"
publish = true
release = true

# ============================================================================
# Changelog configuration powered by git-cliff
# ============================================================================
[changelog]
header = """
# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.1.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).
"""

body = """
{% if version -%}
## [{{ version | trim_start_matches(pat="v") }}] - {{ timestamp | date(format="%Y-%m-%d") }}
{% else -%}
## [Unreleased]
{% endif -%}
{% for group, commits in commits | group_by(attribute="group") %}
### {{ group | upper_first }}
{% for commit in commits -%}
- {% if commit.breaking %}[**breaking**] {% endif %}{{ commit.message | upper_first | trim }}{% if commit.github.username %} by @{{ commit.github.username }}{% endif %}
{% endfor -%}
{% endfor -%}
{% if version and previous.version -%}
[{{ version | trim_start_matches(pat="v") }}]: https://github.com/nutthead/samoyed/compare/{{ previous.version }}..{{ version }}
{% endif -%}

<!-- generated by release-plz + git-cliff -->
"""

trim = true
protect_breaking_commits = true
# Match stable tags like v1.2.3 and ignore pre-release suffixes
tag_pattern = "^v\\d+\\.\\d+\\.\\d+$"
sort_commits = "oldest"
commit_preprocessors = [
  # Remove issue numbers from commits
  { pattern = '\\((\\w+\\s)?#([0-9]+)\\)', replace = "" },
  # Remove PR numbers from commits
  { pattern = '\\s*\\(#[0-9]+\\)$', replace = "" },
]
commit_parsers = [
  # Skip rule: ONLY commits with $no-changelog tag are excluded from changelog
  { body = ".*\\$no-changelog", skip = true },

  # Primary: Tag-based grouping (footer $tag determines changelog category)
  { body = ".*\\$feat", group = "â­ Features" },
  { body = ".*\\$fix", group = "ğŸ› Bug Fixes" },
  { body = ".*\\$docs", group = "ğŸ“š Documentation" },
  { body = ".*\\$perf", group = "âš¡ Performance" },
  { body = ".*\\$refactor", group = "ğŸ”¨ Refactor" },
  { body = ".*\\$style", group = "ğŸ¨ Styling" },
  { body = ".*\\$test", group = "ğŸ§ª Testing" },
  { body = ".*\\$build", group = "ğŸ“¦ Build System" },
  { body = ".*\\$ci", group = "ğŸ‘· CI/CD" },
  { body = ".*\\$revert", group = "âª Reverts" },
  { body = ".*\\$chore", group = "ğŸ§¹ Miscellaneous" },
  { body = ".*\\$misc", group = "ğŸ§¹ Miscellaneous" },

  # Special cases
  { body = ".*security", group = "ğŸ” Security" },

  # Fallback: Message-based grouping (for commits without tags)
  { message = "^feat", group = "â­ Features" },
  { message = "^fix", group = "ğŸ› Bug Fixes" },
  { message = "^docs", group = "ğŸ“š Documentation" },
  { message = "^doc", group = "ğŸ“š Documentation" },
  { message = "^perf", group = "âš¡ Performance" },
  { message = "^refactor", group = "ğŸ”¨ Refactor" },
  { message = "^style", group = "ğŸ¨ Styling" },
  { message = "^test", group = "ğŸ§ª Testing" },
  { message = "^chore", group = "ğŸ§¹ Miscellaneous" },
  { message = "^revert", group = "âª Reverts" },
  { message = "^build", group = "ğŸ“¦ Build System" },
  { message = "^ci", group = "ğŸ‘· CI/CD" },

  # Catch-all
  { message = ".*", group = "ğŸ§¹ Miscellaneous" },
]
