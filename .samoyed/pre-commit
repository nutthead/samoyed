#!/usr/bin/env sh
set -e # Exit on any error

echo "ğŸš€ Pre-commit: start"
echo

# Rust: Type checking
echo "ğŸ” Type-checking with cargo checkâ€¦"
if ! cargo check --quiet; then
    echo "âŒ Type checking failed"
    exit 1
fi
echo "âœ… Type checking passed"
echo

# Rust: Linting
echo "ğŸ§¹ Linting with cargo clippyâ€¦"
if ! cargo clippy --all-targets --all-features -- -D warnings; then
    echo "âŒ Clippy linting failed"
    exit 1
fi
echo "âœ… Clippy linting passed"
echo

# Rust: Formatting (format staged files and re-add them)
echo "ğŸ“ Formatting staged Rust files with cargo fmtâ€¦"
staged_rust_files=$(git ls-files --cached '*.rs')
if [ -n "$staged_rust_files" ]; then
    echo "  Formatting: $staged_rust_files"
    # Format the specific staged files
    # shellcheck disable=SC2086 # We want word splitting here
    cargo fmt -- $staged_rust_files
    # Modern way to re-stage files that were modified by the hook
    git update-index --again
    echo "âœ… Staged Rust files formatted and re-staged"
else
    echo "â„¹ï¸  No staged Rust files to format"
fi
echo

# Shell: Shellcheck validation
echo "ğŸš Checking shell scripts with shellcheckâ€¦"
shell_scripts_found=false

# Check integration test scripts
for script in tests/integration/*.sh; do
    if [ -f "$script" ]; then
        shell_scripts_found=true
        echo "  Checking $script"
        # Only fail on errors and warnings, ignore info-level issues
        if ! shellcheck -x -s sh -S warning "$script"; then
            echo "âŒ Shellcheck failed for $script"
            exit 1
        fi
    fi
done

# Check this pre-commit hook itself
if [ -f ".samoyed/pre-commit" ]; then
    shell_scripts_found=true
    echo "  Checking .samoyed/pre-commit"
    if ! shellcheck -s sh -S warning ".samoyed/pre-commit"; then
        echo "âŒ Shellcheck failed for .samoyed/pre-commit"
        exit 1
    fi
fi

if [ "$shell_scripts_found" = true ]; then
    echo "âœ… All shell scripts passed shellcheck"
else
    echo "â„¹ï¸  No shell scripts found to check"
fi
echo

# Shell: Formatting (format staged files and re-add them)
echo "ğŸ“ Formatting staged shell scripts with shfmtâ€¦"
if command -v shfmt >/dev/null 2>&1; then
    staged_shell_files=$(git ls-files --cached '*.sh')
    if [ -n "$staged_shell_files" ]; then
        echo "  Formatting: $staged_shell_files"
        # Format the specific staged files with 4-space indentation
        # shellcheck disable=SC2086 # We want word splitting here
        shfmt -i 4 -w $staged_shell_files
        # Modern way to re-stage files that were modified by the hook
        git update-index --again
        echo "âœ… Staged shell scripts formatted and re-staged"
    else
        echo "â„¹ï¸  No staged shell scripts to format"
    fi
else
    echo "â„¹ï¸  shfmt not found, skipping shell script formatting"
fi
echo

# Rust: Unit tests
echo "ğŸ§ª Running unit testsâ€¦"
if ! cargo test --quiet -- --test-threads=1; then
    echo "âŒ Unit tests failed"
    exit 1
fi
echo "âœ… Unit tests passed"
echo

echo "ğŸ‰ Pre-commit: all checks passed!"
