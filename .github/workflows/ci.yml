# ============================================================================
# Enhanced CI Pipeline with Modern Optimizations
# ============================================================================
# High-performance CI workflow featuring:
# - Intelligent caching strategies
# - Parallel job execution
# - Fail-fast for critical checks
# - Dependency caching with cargo-binstall
# - Sccache for distributed compilation caching
# - Merge queue support

name: CI Enhanced

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [master]
  merge_group:
    types: [checks_requested]
  workflow_dispatch:
  schedule:
    # Weekly security audit
    - cron: '0 0 * * MON'

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  RUST_VERSION: "1.90.0"
  CARGO_TERM_COLOR: always
  CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse
  RUST_BACKTRACE: short
  RUSTFLAGS: "-D warnings"

permissions:
  contents: read
  pull-requests: write
  actions: read
  checks: write

jobs:
  # ============================================================================
  # Quick Checks - Fail fast on basic issues
  # ============================================================================
  quick-check:
    name: Quick Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1.15.0
        with:
          toolchain: 1.90.0
          components: rustfmt, clippy

      # Cache Rust dependencies
      - name: Cache cargo directories
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-1.90.0-${{ hashFiles('**/Cargo.lock') }}

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Clippy (fail-fast)
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Check documentation
        run: cargo doc --no-deps --all-features
        env:
          RUSTDOCFLAGS: "-D warnings"

  # ============================================================================
  # Dependency Audit - Security scanning
  # ============================================================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    continue-on-error: true  # Don't fail the build on advisories
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1.15.0
        with:
          toolchain: 1.90.0

      # Use cargo-binstall for faster tool installation
      - name: Install cargo-binstall
        uses: cargo-bins/cargo-binstall@latest

      - name: Install security tools
        run: |
          cargo binstall --no-confirm --locked cargo-audit cargo-deny

      - name: Security audit
        run: |
          cargo audit --json | tee audit.json
          cargo deny check advisories

      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit
          path: audit.json
          retention-days: 30

  # ============================================================================
  # Test Matrix - Comprehensive testing across platforms
  # ============================================================================
  test:
    name: Test ${{ matrix.name }}
    needs: [quick-check]
    strategy:
      fail-fast: false
      matrix:
        include:
          # Primary platforms
          - os: ubuntu-latest
            name: Linux
            target: x86_64-unknown-linux-gnu
            test_args: ""

          - os: macos-14
            name: macOS (ARM)
            target: aarch64-apple-darwin
            test_args: ""

          - os: windows-latest
            name: Windows
            target: x86_64-pc-windows-msvc
            test_args: ""

          # Additional test configurations
          - os: ubuntu-latest
            name: Linux (musl)
            target: x86_64-unknown-linux-musl
            test_args: ""

          - os: ubuntu-latest
            name: Minimal Versions
            target: x86_64-unknown-linux-gnu
            test_args: "-Z minimal-versions"
            toolchain: nightly

    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1.15.0
        with:
          toolchain: ${{ matrix.toolchain || '1.90.0' }}
          targets: ${{ matrix.target }}
          components: clippy, rustfmt

      # Platform-specific caching
      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
          prefix-key: "v2-rust"
          key: ${{ matrix.target }}-${{ matrix.name }}
          save-if: ${{ github.ref == 'refs/heads/master' }}

      # Install musl tools if needed
      - name: Install musl tools
        if: contains(matrix.target, 'musl')
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools

      # Build
      - name: Build
        run: cargo build --target ${{ matrix.target }} ${{ matrix.test_args }}

      # Test with single thread (required by project)
      - name: Run tests
        run: |
          cargo test --target ${{ matrix.target }} ${{ matrix.test_args }} \
            -- --test-threads=1

      # Run integration tests
      - name: Integration tests
        if: matrix.name != 'Minimal Versions'
        run: |
          cargo build --release --target ${{ matrix.target }}
          for script in tests/integration/*.sh; do
            echo "Running ${script}"
            bash "$script"
          done
        shell: sh

  # ============================================================================
  # Coverage Analysis with Tarpaulin
  # ============================================================================
  coverage:
    name: Code Coverage
    needs: [test]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1.15.0
        with:
          toolchain: 1.90.0

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: false
          save-if: false

      # Use cargo-binstall for faster installation
      - name: Install cargo-binstall
        uses: cargo-bins/cargo-binstall@v1.10.3

      - name: Install tarpaulin
        run: cargo binstall --no-confirm --locked cargo-tarpaulin

      - name: Generate coverage
        run: |
          # Using settings from .tarpaulin.toml
          cargo tarpaulin --timeout 120 --avoid-cfg-tarpaulin

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: target/tarpaulin/cobertura.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      # Comment on PR with coverage
      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coverage = JSON.parse(fs.readFileSync('target/tarpaulin/tarpaulin-report.json', 'utf8'));
            const percent = (coverage.coverage * 100).toFixed(2);

            const body = `## üìä Coverage Report

            **Coverage**: ${percent}%

            | Metric | Value |
            |--------|-------|
            | Lines Covered | ${coverage.covered_lines} |
            | Total Lines | ${coverage.total_lines} |
            | Files | ${Object.keys(coverage.files).length} |

            <details>
            <summary>View detailed report</summary>

            \`\`\`
            ${Object.entries(coverage.files)
              .map(([file, data]) => `${file}: ${(data.coverage * 100).toFixed(1)}%`)
              .join('\n')}
            \`\`\`

            </details>

            ---
            *Generated by cargo-tarpaulin*
            `;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # ============================================================================
  # Final Status Check
  # ============================================================================
  ci-success:
    name: CI Success
    if: always()
    needs: [quick-check, security, test, coverage]
    runs-on: ubuntu-latest
    steps:
      - name: Check status
        run: |
          if [[ "${{ needs.quick-check.result }}" != "success" ]] ||
             [[ "${{ needs.test.result }}" != "success" ]] ||
             [[ "${{ needs.coverage.result }}" != "success" ]]; then
            echo "‚ùå CI failed"
            exit 1
          fi
          echo "‚úÖ All CI checks passed"

      # Add status check for merge queue
      - name: Set merge queue status
        if: github.event_name == 'merge_group'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'CI Status',
              head_sha: context.sha,
              status: 'completed',
              conclusion: 'success',
              output: {
                title: 'CI Passed',
                summary: 'All CI checks completed successfully'
              }
            });