Context:
  The specification for Samoyed is written below, after the next horizontal rule.
  Execute the following workflow to implement Samoyed according to its specification in Rust.

Rules:
  - Unit tests MUST NOT modify any files outside the temporary directories created for testing and the `/tmp` directory.
  - Adhoc scripts or code that modifies files outside the temporary directories created for testing and the `/tmp` directory MUST NOT be written.

Workflow:
  let adoptedMindsets = AdoptMindsets(Systematic, Methodical, Thorough, Exact, Diligent) in
    forEach mindset in adoptedMindsets
      Println(Define(mindset))
      Println(Embody(mindset));

  Read(Samoyed Specification for Developers) ->
    Ultrathink ->
    Analyze ->
    Think ->
    ExtractFacts ->
    Think ->
    Distill ->
    Think ->
    Synthesize ->
    Ultrathink ->
    Implement(include: "comprehensive, eloquent rustdoc comments") ->
    Format(using: "cargo fmt") ->
    Lint(using: "cargo clippy", onFailure: "Fix lint errors") ->
    Compile(using: "cargo build", onFailure: "Fix compilation errors");

  Read(src/main.rs assets/samoyed) ->
    Ultrathink ->
    AddAdditionalLibrariesForUnitTesting(ifNeeded: true) ->
    WriteUnitTests ->
    RunTests(using: "cargo test", exclude: "Windows and macOS tests", onFailure: "Ultrathink, find and fix root cause of test failures") ->
    EnsureAllTestsPass ->
    MeasureCodeCoverage(using: "cargo tarpaulin", onFailure: "Ulrathink, strategize, and write more unit tests to improve coverage");

  Instruction(Explain what you are doing when you do it);
---

# Samoyed Specification for Developers

The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in [RFC 2119](https://datatracker.ietf.org/doc/html/rfc2119).

## Goal

Build _Samoyed_, a cross-platform tool written in Rust that simplifies and streamlines how users work with client-side _Git Hooks_.

Samoyed avoids feature-creep. Also, fortunately, as managing and working with client-side Git hooks is very simple, the entire Rust code for Samoyed can and MUST fit in a single file, `./src/main.rs`.

Samoyed's source code has a 2nd file, `./assets/samoyed`, which is a POSIX shell script that is used as a Git hook wrapper. When `samoyed init [samoyed-dirname]` is executed inside a git repository, `./assets/samoyed` MUST be copied into the current repository's `[samoyed-dirname]/_` directory when `samoyed init [samoyed-dirname]` is executed inside a git repository.

**NOTE 1:** The `[samoyed-dirname]` is an optional argument to the `samoyed init` command. If not provided, its value defaults to `.samoyed`.
**NOTE 2:** Use an appropriate Rust technique such as `include_bytes!` to embed `./assets/samoyed` into the compiled binary, so that the binary is self-contained and does not depend on any external files.

## Coding Rules

* All the Rust code for Samoyed MUST fit and MUST reside in `src/main.rs`
* Mega functions, God Objects, and similar anti-patterns MUST be avoided
* Code MUST be split into as many functions as needed, and each function MUST have a "cognitive-complexity-threshold" less than or equal to 21
* A function MUST be split into two or more functions, if and only if, there is a logical reason to do so AND/OR the resulting code is more readable and easier to understand and unit test
* You MUST follow the [DRY](https://en.wikipedia.org/wiki/Don%27t_repeat_yourself) principle
* You MUST write code with unit testability in mind and code that you write MUST be easily unit testable
* You MUST avoid overengineering
* You MUST document the code using rustdoc comments
* You MUST NOT add any **dependencies** to `Cargo.toml`
* You MAY add **dev-dependencies** and **build-dependencies** to `Cargo.toml`, if and only if, they are absolutely necessary
* You MUST adopt a structure for the code that allows additional files and directories to be created by Samoyed, or the code that already creates files and directories to be easily removed or modified

## CLI

### `samoyed`, `samoyed --help`, and `samoyed -h`

Running `samoyed`, `samoyed --help`, or `samoyed -h` MUST print the help message automatically generated by the [clap](https://crates.io/crates/clap) crate to `stdout` and exit with a zero exit code.

### `samoyed init [samoyed-dirname]`

Running `samoyed init [samoyed-dirname]` in an environment where the `SAMOYED` environment variable is set to `0` MUST print the message `Bypassing samoyed init due to SAMOYED=0` to `stdout` and exit with a zero exit code.

Running `samoyed init [samoyed-dirname]` outside a git repository MUST print an error message: `Error: Not a git repository` to `stderr` and exit with a non-zero exit code.

**NOTE 3:** `[samoyed-dirname]` is an optional argument. If not provided, its value defaults to `.samoyed`.
**NOTE 4:** To check if the current directory is inside a git repository, you MUST use the command `git rev-parse --is-inside-work-tree` and check its exit code. If and only if the exit code is zero AND the command's output is `true`, then the current directory is inside a git repository.

Running `samoyed init [samoyed-dirname]` inside a git repository:

* MUST create a `[samoyed-dirname]` directory in the root of the git repository, if it does not already exist
* MUST create a `[samoyed-dirname]/_` directory

**NOTE 5:** When `[samoyed-dirname]` is provided, then it MUST resolve to a path that is inside the current git repository. Otherwise, the message `Error: [samoyed-dirname] is outside the [absolute path] git repository` MUST be printed to `stderr` and the program MUST exit with a non-zero exit code. For example, let's assume we are inside `/home/user/Code/my-repo` which is a git repository according to `git rev-parse --is-inside-work-tree`. Then, `..` is not a valid value for `[samoyed-dirname]`, because it resolves to a path that is outside the current git repository. Hence a non-zero exit code MUST be returned and the message `Error: /home/user is outside the /home/user/Code/my-repo git repository` MUST be printed to `stderr`.

Running `samoyed init [samoyed-dirname]` inside a git repository MUST copy `assets/samoyed` to `[samoyed-dirname]/_` and set its permission to `644`:

Running `samoyed init [samoyed-dirname]` inside a git repository MUST also create the following files inside the `[samoyed-dirname]/_` directory (collectively referred to as the "hook scripts") and set the file permission for each of them to `755`:

* `applypatch-msg`
* `commit-msg`
* `post-applypatch`
* `post-checkout`
* `post-commit`
* `post-merge`
* `post-rewrite`
* `pre-applypatch`
* `pre-auto-gc`
* `pre-commit`
* `pre-merge-commit`
* `pre-push`
* `pre-rebase`
* `prepare-commit-msg`

All the hook scripts MUST contain the following code, including the last newline:

```sh
base_name=$(basename "$0")
abs_path=$(dirname "$(dirname "$0")")/$base_name

echo "I am the ${base_name} hook. Change me at: ${abs_path}."

```

Running `samoyed init [samoyed-dirname]` inside a git repository MUST create a file named `[samoyed-dirname]/pre-commit`, a sample hook script, and set its file permissions to `644`. The file MUST contain the following code, including the last newline:

```sh
#!/usr/bin/env sh
. "$(dirname "$0")/samoyed"

```

**NOTE 6:** `[samoyed-dirname]` is an optional argument. If not provided, it defaults to `.samoyed`.

Running `samoyed init [samoyed-dirname]` inside a git repository:

MUST set `core.hooksPath` for the current repository to `[samoyed-dirname]/_`.

**NOTE 7:** To set `core.hooksPath`, you MUST use the command `git config core.hooksPath [samoyed-dirname]/_`.

Running `samoyed init [samoyed-dirname]` inside a git repository:

MUST create a `.gitignore` file inside `[samoyed-dirname]/_` with the following contents (including the last newline), if `[samoyed-dirname]/_/.gitignore` does not already exist:

```
*

```
